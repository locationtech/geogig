<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, maximum-scale=1">
  
  <title>Hooks &mdash; GeoGig 1.0 User Manual</title>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,600italic,700italic,800italic,300,700,600,800,400' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="../_static/screen.css" type="text/css" media="screen, projection" />
  <link rel="stylesheet" href="../_static/print.css" type="text/css" media="print" />
  <!--[if IE]>
  <link rel="stylesheet" href="../_static/blueprint/ie.css" type="text/css" media="screen, projection" />
  <![endif]-->
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
   <link rel="stylesheet" href="../_static/bootstrap.min.css" type="text/css" />
  <link rel="stylesheet" href="../_static/offcanvas.css" type="text/css" />
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html'
    };
  </script>
      <link rel="top" title="GeoGig 1.0 User Manual" href="../index.html" />
      <link rel="up" title="Working with repositories" href="index.html" />
      <link rel="next" title="Partial cloning" href="partialcloning.html" />
      <link rel="prev" title="Modifying history" href="history.html" />
</head>
<body class="repo/hooks">
    <div id="blacktop"></div>
    <header id="masthead">
      <div class="navbar">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://geogig.org"><h1>GeoGig</h1></a>
          </div>
          <div class="navbar-collapse collapse navbar-right">
            <ul class="nav navbar-nav">
              <li><a href="http://geogig.org/#install">Get Started</a></li>
              <li><a href="http://geogig.org/docs/index.html">Documentation</a></li>
              <li><a href="https://github.com/locationtech/geogig">On Github</a></li>
            </ul>
          </div><!--/.navbar-collapse -->
        </div>
      </div>
    </header>

    <section class="subheading hidden-xs">
      <div class="container">
        <div class="row">
          <div class="col-md-8">
            <p class="byline">A Tool for Geospatial Data Management</p>
          </div>
        </div>
      </div>
    </section>
    <a name="top"></a>

 <div id="main">
    <div class="wrap selfclear">
      <div id="content">
      <div class="container">
        <div class="row row-offcanvas row-offcanvas-right">
          <div class="col-md-8">
            <div class="row pull-right">
             <div class="visible-sm visible-xs" id="menu-btn">
                <button class="btn btn-blue btn-sm"type="button" data-toggle="offcanvas">
                  <span class="btn-text active">Menu &rarr;</span>
                  <span class="btn-back">&larr; Back</span>
                </button>
              </div>
            </div>
<ul id="breadcrumbs">
  
  <li><a href="../index.html">GeoGig 1.0 User Manual</a> &raquo;</li>
  <li><a href="index.html" accesskey="U">Working with repositories</a> &raquo;</li>
  <li>Hooks</li>
</ul>
<ul id="relatedlinks" class="selfclear">
  <li class="first">
    <a href="../genindex.html" title="General Index"
       accesskey="I">index</a></li>
  <li>
    <a href="partialcloning.html" title="Partial cloning"
       accesskey="N">next</a>|</li>
  <li>
    <a href="history.html" title="Modifying history"
       accesskey="P">previous</a>|</li>
</ul>
        
  <div class="section" id="hooks">
<h1>Hooks<a class="headerlink" href="#hooks" title="Permalink to this headline">¶</a></h1>
<p>GeoGig supports the usage of <strong>hooks</strong>, commands that are executed before or after a given operation is run.</p>
<p>Hooks are written in a supported scripting language, and stored in the <tt class="docutils literal"><span class="pre">hooks</span></tt> directory in the GeoGig repository directory (<tt class="docutils literal"><span class="pre">.geogig</span></tt>).</p>
<p>There are two types of hooks, <strong>pre-execution</strong> and <strong>post-execution</strong>, which happen before or after a given operation, respectively.</p>
<p>To prevent erroneous behavior, don&#8217;t have multiple files containing the same type of hook. (As in, don&#8217;t have both <tt class="docutils literal"><span class="pre">pre_commit.py</span></tt> and <tt class="docutils literal"><span class="pre">pre_commit.js</span></tt>.)</p>
<div class="section" id="pre-execution">
<h2>Pre-execution<a class="headerlink" href="#pre-execution" title="Permalink to this headline">¶</a></h2>
<p>When an operation is executed, GeoGig searches for a corresponding hook to run <strong>before</strong> the actual operation is run.</p>
<p>A pre-execution hook should have the prefix <tt class="docutils literal"><span class="pre">pre_</span></tt> and the name of the operation before which is to be executed, and the extension of the corresponding scripting language used. A Python hook to be run before executing a commit operation should be, hence, named <tt class="docutils literal"><span class="pre">pre_commit.py</span></tt>.</p>
<p>All hooks have a global variable named <tt class="docutils literal"><span class="pre">params</span></tt> that can be used to check the current operation parameters. It is a map containing the actual values of fields in the object representing the operation. Those values represent the arguments used when calling the the operation was invoked. Map keys are field names.</p>
<p>Here is an example of a Python pre-commit hook that illustrates the mechanism explained above. This hook ensures a minimum length for commit messages and convert the text to lower case. As is affects the <tt class="docutils literal"><span class="pre">commit</span></tt> operation, it should be named <tt class="docutils literal"><span class="pre">pre_commit.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">exception</span> <span class="o">=</span> <span class="n">Packages</span><span class="o">.</span><span class="n">org</span><span class="o">.</span><span class="n">geogig</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">CannotRunGeogigOperationException</span><span class="p">;</span>
<span class="n">msg</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;message&quot;</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">length</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">){</span>
  <span class="n">throw</span> <span class="n">new</span> <span class="n">exception</span><span class="p">(</span><span class="s">&quot;Commit messages must have at least 30 letters&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">params</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;message&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">toLowerCase</span><span class="p">());</span>
</pre></div>
</div>
<p>Pre-execution hooks can halt the normal execution of the operation, and thus be used to perform diagnostic checks. To indicate that the operation shouldn&#8217;t be executed, a <tt class="docutils literal"><span class="pre">CannotRunGeogigOperationException</span></tt> has to be thrown. Any other exception type is assumed to be due to an error in the script and will not block the execution of the operation.</p>
</div>
<div class="section" id="post-execution">
<h2>Post-execution<a class="headerlink" href="#post-execution" title="Permalink to this headline">¶</a></h2>
<p>GeoGig also supports post-execution hooks. Post-execution hooks run <strong>after</strong> the operation has been executed. Because of when they run, they are not expected to throw exceptions.</p>
<p>Post execution hooks should be used to perform management tasks once the corresponding operation has been executed. for instance, a post-execution hook linked to the export operation (<tt class="docutils literal"><span class="pre">post_export</span></tt>) can be used to execute mantainence operations on the data exported from GeoGig, like building spatial indexes or vacuuming a PostGIS table whenever data is exported from GeoGig into it.</p>
<p>A post execution hook is named using the prefix <tt class="docutils literal"><span class="pre">post_</span></tt> and the name of the operation after which it is to be executed, and the extension of the corresponding scripting language used.</p>
</div>
<div class="section" id="samples">
<h2>Samples<a class="headerlink" href="#samples" title="Permalink to this headline">¶</a></h2>
<p>GeoGig repositories contain a set of sample hooks. They are not active by default, but can be enabled by removing the <tt class="docutils literal"><span class="pre">.sample</span></tt> suffix from their filename. (For example, a hook named <tt class="docutils literal"><span class="pre">pre_commit.js.sample</span></tt>.)</p>
</div>
<div class="section" id="supported-hooks">
<h2>Supported hooks<a class="headerlink" href="#supported-hooks" title="Permalink to this headline">¶</a></h2>
<p>GeoGig supports hooks for the following operations:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">commit</span></tt></li>
<li><tt class="docutils literal"><span class="pre">rebase</span></tt></li>
<li><tt class="docutils literal"><span class="pre">checkout</span></tt></li>
<li><tt class="docutils literal"><span class="pre">apply</span></tt></li>
<li><tt class="docutils literal"><span class="pre">osmimport</span></tt></li>
<li><tt class="docutils literal"><span class="pre">import</span></tt></li>
<li><tt class="docutils literal"><span class="pre">export</span></tt></li>
</ul>
</div>
<div class="section" id="scripting-api">
<h2>Scripting API<a class="headerlink" href="#scripting-api" title="Permalink to this headline">¶</a></h2>
<p>When creating a hook, it might be necessary to access some of the functions of GeoGig. To do this, use the GeoGig scripting API.</p>
<p>A global variable named <tt class="docutils literal"><span class="pre">geogig</span></tt> is available to access the GeoGig API. It contains an instance of an object of type <tt class="docutils literal"><span class="pre">GeoGigAPI</span></tt>, which wraps GeoGig operations and provides methods to easily access it.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">See the API documentation for detailed information about its methods.</p>
</div>
<p>To illustrate the usage of this, below is an example of a hook that prevents committing features with topologically incorrect geometries.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">Validator</span> <span class="o">=</span> <span class="nb">Packages</span><span class="p">.</span><span class="nx">com</span><span class="p">.</span><span class="nx">vividsolutions</span><span class="p">.</span><span class="nx">jts</span><span class="p">.</span><span class="nx">operation</span><span class="p">.</span><span class="nx">valid</span><span class="p">.</span><span class="nx">IsValidOp</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">features</span> <span class="o">=</span> <span class="nx">geogig</span><span class="p">.</span><span class="nx">getFeaturesToCommit</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">features</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">feature</span> <span class="o">=</span> <span class="nx">features</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
  <span class="nx">geom</span> <span class="o">=</span> <span class="nx">feature</span><span class="p">.</span><span class="nx">getDefaultGeometry</span><span class="p">();</span>
  <span class="nx">op</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Validator</span><span class="p">(</span><span class="nx">geom</span><span class="p">)</span> <span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">op</span><span class="p">.</span><span class="nx">isValid</span><span class="p">()){</span>
    <span class="nx">geogig</span><span class="p">.</span><span class="nx">throwHookException</span><span class="p">(</span><span class="nx">op</span><span class="p">.</span><span class="nx">getValidationError</span><span class="p">().</span><span class="nx">getMessage</span><span class="p">());</span>
  <span class="p">}</span>
</pre></div>
</div>
<p>More elaborate hooks can be created making use of the API along with the GeoTools classes that GeoGig uses internally, such as reprojecting geometries before importing them into the repository.</p>
<p>Also, GeoGig commands can be called from the script, using the <tt class="docutils literal"><span class="pre">run()</span></tt> method from the <tt class="docutils literal"><span class="pre">geogig</span></tt> object. It takes the name of the class with the command to call as the first parameter. the second parameter contains the names and values of the parameters needed by that command to be executed.</p>
<p>The following is an example hook that triggers an OpenStreetMap &#8220;unmapping&#8221; operation whenever the <tt class="docutils literal"><span class="pre">mapped</span></tt> tree (which is supposed to contain mapped OSM data), is modified after a commit.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">diffs</span> <span class="o">=</span> <span class="nx">geogig</span><span class="p">.</span><span class="nx">getFeaturesToCommit</span><span class="p">(</span><span class="s1">&#39;mapped&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">diffs</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;path&quot;</span> <span class="o">:</span> <span class="s2">&quot;mapped&quot;</span><span class="p">};</span>
    <span class="nx">geogig</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="s2">&quot;org.geogig.osm.internal.OSMUnmapOp&quot;</span><span class="p">,</span> <span class="nx">params</span><span class="p">);</span>
  <span class="p">}</span>
</pre></div>
</div>
<p>The above code would be placed in a file named <tt class="docutils literal"><span class="pre">post_commit.js</span></tt></p>
</div>
</div>


      <div class="selfclear pagination-nav">
          <div class="leftwise"><strong>Previous</strong>: <a href="history.html" title="previous chapter">Modifying history</a></div>
          <div class="rightwise"><strong>Next</strong>: <a href="partialcloning.html" title="next chapter">Partial cloning</a></div>
      </div>
      <p class="centered-text"><a href="#top"><img src="../_static/arrow_up.png" alt="back to top"/></a></p>
      </div><!-- /#content> -->
  <div id="sidebar" class="sidebar-offcanvas contrast col-sm-4 sidebar-offcanvas" id="sidebar" role="navigation">

    <div>
         <form id="quick-search" action="search.html" method="get" style="width: 100%;">
          <fieldset>
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
            <input id="quick-search-query" type="text" name="q" accessKey="q" name="searchQuery.queryString" size="25" value="Search Documentation&hellip;" size="20" tabindex="3" onblur="if(this.value=='') this.value='Search Documentation&hellip;';" onfocus="if(this.value=='Search Documentation&hellip;') this.value='';" />
          </fieldset>
        </form>


        <div class="btn-group-vertical" id="docs_toc">
          <button type="button" class="btn btn-default"><a href="/docs/">User Manual</a></button>
          <button type="button" class="btn btn-default"><a href="/technical/">Technical Manual</a></button>
          <button type="button" class="btn btn-default"><a href="/manpages/">Man Pages</a></button>
          <button type="button" class="btn btn-default"><a href="/workshop/">Workshop</a></button>
      </div>
      <h3 class="pngfix">Table Of Contents</h3>
        <ul>
<li><a class="reference internal" href="#">Hooks</a><ul>
<li><a class="reference internal" href="#pre-execution">Pre-execution</a></li>
<li><a class="reference internal" href="#post-execution">Post-execution</a></li>
<li><a class="reference internal" href="#samples">Samples</a></li>
<li><a class="reference internal" href="#supported-hooks">Supported hooks</a></li>
<li><a class="reference internal" href="#scripting-api">Scripting API</a></li>
</ul>
</li>
</ul>

        <div class="section-footer"></div>
      </div>
        <div class="section continue_reading">
          <h3>Continue Reading</h3>
          <ul>
            <li>Previous: <a href="history.html" title="previous chapter">Modifying history</a></li>
            <li>Next: <a href="partialcloning.html" title="next chapter">Partial cloning</a></li>
          </ul>
        </div>
        <div class="section">
        <h3>This Page</h3>
        <ul class="this-page-menu">
          <li><a href="../_sources/repo/hooks.txt">Show Source</a></li>
        </ul>
        </div>
        <div class="section">
          <h3>License</h3>
          <p>This project is licensed under the <a href="https://github.com/locationtech/geogig/blob/master/LICENSE.txt">BSD New License</a>.</p>
        </div>

  </div><!-- /#sidebar -->
  </div><!-- /.wrap> -->
</div>
</div>

</div><!-- /#main -->
    <footer>
      <div class="container">
        <div class="row">
          <div class=""><p class="repo-owner"><a href="https://github.com/locationtech/geogig">GeoGig</a> is maintained by <a href="https://github.com/boundlessgeo"><img src="../_static/Boundless_Logo.png" alt="Boundless"></a></p></div>
        </div>
      </div>
    </footer>


  <script type="text/javascript" src="../_static/jquery.js"></script>
  <script type="text/javascript" src="../_static/jquery-migrate-min.js"></script>
  <script type="text/javascript" src="../_static/bootstrap.js" ></script>
  <script type="text/javascript" src="../_static/underscore.js"></script>
  <script type="text/javascript" src="../_static/doctools.js"></script>
  <script type="text/javascript" src="../_static/searchtools.js"></script>
  <script type="text/javascript" src="../searchindex.js"></script>
  <script>
      $(document).ready(function() {

      $('[data-toggle=offcanvas]').click(function(e) {
        e.stopPropagation();
        $('.row-offcanvas').toggleClass('active');
        $('.btn-back').toggleClass('active');
        $('.btn-text').toggleClass('active');
      });
      $('.list-group-item').click(function(e) {
        e.stopPropagation();
        $('.row-offcanvas').toggleClass('active');
        $('.btn-back').toggleClass('active');
        $('.btn-text').toggleClass('active');
      });
    });
  </script>
  <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-3879903-19']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
  </script>
  </body>
</html>
